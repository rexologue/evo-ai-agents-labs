# Инструкция по запуску MCP-сервера в ai-agents

---

## Как написать MCP-сервер?

Мы разберем как написать MCP-сервер расчета кредитов и вкладов.

Все файлы кроме ```src/main.py``` отвечают за реализацию тулов, которая в вашем случае будет отличаться, поэтому сфокусируемся на 
```src/main.py```. 

### 1. Что такое MCP-сервер

MCP-сервер — это сервис, предоставляющий набор инструментов (tools), к которым может обращаться агент. Каждый инструмент — это функция Python, зарегистрированная в фреймворке **FastMCP**.

FastMCP берёт на себя:

* запуск сервера (SSE),
* регистрацию и описание инструментов,
* сериализацию/десериализацию аргументов и результатов,
* автоматическую генерацию спецификаций для клиента.

### 2. Базовая структура

MCP-сервер обычно состоит из:

* **основного файла** (`main.py`), где создаётся экземпляр `FastMCP`, подключаются инструменты и запускается сервер,
* **описаний инструментов** через декоратор `@mcp.tool`.
* **модулей с бизнес-логикой** (например, расчёты, валидации),

Пример создания сервера:

```python
import os
from fastmcp import FastMCP

mcp = FastMCP("Finance Schedules")

if __name__ == "__main__":
    mcp.run(
        transport="sse",          # транспорт (sse или websocket)
        host="0.0.0.0",           # адрес
        port=os.getenv("PORT", 8000)  # порт по умолчанию 8000
    )
```

После запуска сервер слушает входящие запросы и выполняет зарегистрированные инструменты.

### 3. Регистрация инструментов

Инструменты определяются как обычные функции Python, аннотированные декоратором `@mcp.tool`.

```python
@mcp.tool
def loan_schedule_annuity(principal: float, annual_rate_percent: float, months: int) -> dict:
    """Полное и достаточное описание инструмента"""
    # валидации и расчёты
    return {"summary": {...}, "schedule": [...]}
```

FastMCP автоматически:

* создаёт описание инструмента (имя, аргументы, возвращаемый тип) из аннотаций и docstring,
* добавляет его в спецификацию сервера,
* обрабатывает вызовы с аргументами.

### 4. Как правильно писать описания MCP-тулов

Чтобы инструменты были понятны и клиенту, и агенту, рекомендуется придерживаться следующих правил:

1. **Docstring обязателен**
   Первые 1–2 строки — краткое назначение инструмента. Далее — подробное описание формата входных и выходных данных.

2. **Описание аргументов**
   Используй секцию `Args:`. Укажи тип, допустимый диапазон и смысл каждого параметра.

   Пример:

   ```python
   Args:
       principal (float): Сумма кредита (> 0, ≤ лимита).
       annual_rate_percent (float): Годовая ставка в процентах.
       months (int): Срок в месяцах.
   ```

3. **Описание возвращаемых данных**
   Указывай структуру словаря, ключи и что они означают.
   Используй `Returns:` → `Dict[str, Any]`.

4. **Описание исключений**
   Важно явно документировать, при каких условиях поднимается `ValueError` (например, неверные диапазоны).

5. **Дополнительные примечания**
   Если есть округления, коррекции или ограничения, указывай их в `Note:`.



### 5. Рекомендации по стилю

* Один `FastMCP` на весь сервис.
* Логику расчётов выноси в отдельные модули (а в туле только валидация + вызов).
* Docstring должен быть **самодостаточным** — чтобы агент мог понять инструмент только по описанию.
* Используй строгие аннотации типов (`float`, `int`, `bool`) → FastMCP будет валидировать входные данные автоматически.

## Запуск mcp сервера в AI agents

### Важный момент.

MCP сервер в AI agents не должен использовать файловую систему в рантайме. Все манипуляции с ней необходимо делать на этапе сборки docker-образа**

#### Предварительно нужно:
1. Создать реестр в сервисе Artifact Registry.

![create_reestr](docs/create-reestr.png)

2. Создать репозиторий в котором будем хранить наш mcp сервер

![create_repo](docs/create_repo.png)

3. Загрузить docker образ по инструкции

![artifact_upload_doc.png](docs/artifact_upload_doc.png)

3.0 Пройти аутентификацию по инструкции https://cloud.ru/docs/artifact-registry-evolution/ug/topics/quickstart

3.1 Собрать докер образ
```shell
docker buildx build --platform linux/amd64 -t mcp-finance .
```

3.2 Присвойте Docker-образу тег
```shell
docker tag mcp-finance:latest cloudru-labs.cr.cloud.ru/mcp-finance-repo:v1.0.0
```

3.3 Загрузите артефакт в репозиторий
```shell
docker push cloudru-labs.cr.cloud.ru/mcp-finance-repo:v1.0.0
```

![artifact_upload_success.png](docs/artifact_upload_success.png)

4. Создаем mcp сервер через UI cloud.ru

![create_mcp.png](docs/create_mcp.png)

![create_mcp2.png](docs/create_mcp_2.png)

Успешно созданный mcp сервер:

![success_mcp.png](docs/success_mcp.png)

5. Создаем агента с нашими MCP тулами. MCP сервер нужно выбрать в соответствующем поле.

![create_agent.png](docs/create_agent.png)
![create_agent_2.png](docs/create_agent_2.png)

6. Общаемся с агентом.

![agent_chat_1.png](docs/agent_chat_1.png)
![agent_chat_2.png](docs/agent_chat_2.png)
![agent_chat_3.png](docs/agent_chat_3.png)