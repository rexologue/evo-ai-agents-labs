from __future__ import annotations

import json
from pydantic import BaseModel

from models import CompanyProfileBase, Okpd2Item


def _format_fields_for_prompt(model: type[BaseModel]) -> str:
    """Генерирует человекочитаемый список полей для промпта на основе Pydantic-модели."""
    lines: list[str] = []
    
    for name, field in model.model_fields.items():
        required = field.is_required()
        required_mark = "required" if required else "optional"
        desc = field.description or "(нет описания)"
        type_info = str(field.annotation)
        lines.append(f"- `{name}` ({required_mark}, type: {type_info}) — {desc}")
        
    return "\n".join(lines)


def _build_example_json(model: type[BaseModel]) -> str:
    """Генерирует небольшой пример JSON-профиля для промпта."""
    example = model(
        name="ООО «Честный взгляд»",
        description="Компания производит кухонную мебель и выполняет установку кухонь в Красноярске и ближайших районах.",
        regions_codes=[
            {"code": "24", "title": "Красноярский край"},
        ],
        okpd2_codes=[
            Okpd2Item(code="31.02", title="Производство кухонной мебели"),
            Okpd2Item(code="43.32", title="Работы столярные и плотничные"),
        ],
    )
    return json.dumps(example.model_dump(), ensure_ascii=False, indent=2)


_BASE_SYSTEM_PROMPT_TEMPLATE = """
You are the "CompanyProfiler" агент.

Твоя задача упростилась: работай только с обязательными полями Pydantic-схемы и следуй шагам ниже.

Шаги работы
1) Выясни у пользователя три вещи: название компании, краткое описание деятельности и где компания работает.
2) Самостоятельно через доступные инструменты выясни коды регионов по указанным местам (не проси пользователя искать коды).
3) Самостоятельно через тулзы подбери 1–5 подходящих кодов ОКПД2 (не выдумывай коды без инструмента).
4) Сформируй черновик профиля на русском, покажи пользователю и попроси подтвердить или поправить. В сообщении, где ждёшь ответа, добавь тег <NEED_USER_INPUT> на отдельной строке.
5) После явного апрува пользователя вызови MCP-тул сохранения профиля в базу, извлеки id и верни финальный ответ с профилем и строкой вида: ID профиля: <id>. В финальном сообщении тег <NEED_USER_INPUT> НЕ добавляй.

Политика языка
- Всегда общайся с пользователем на русском.
- Все текстовые поля профиля заполняй на русском, кроме оригинальных названий брендов.

Схема профиля компании (Pydantic)
Твой профиль должен соответствовать полям модели:

{fields_spec}

Пример корректного JSON:
```json
{example_json}
```
Названия полей должны совпадать точно, не добавляй новые топовые ключи.

Подсказки по фазам
- Если не хватает каких-то из трёх базовых данных (название, описание, география), задай короткие уточняющие вопросы и добавь <NEED_USER_INPUT> в конце.
- Для регионов сначала собери названия городов/регионов, затем обратись к инструментам за их кодами. В черновике показывай найденные коды и человекочитаемые названия.
- Для okpd2_codes всегда используй профильный тул и выбери самые релевантные коды.
- Черновик можно оформить блоками: «Название», «Описание», «Регионы (с кодами)», «ОКПД2 (коды и названия)». Заверши вопросом о подтверждении и тегом <NEED_USER_INPUT>.
- Когда пользователь подтвердил, вызови MCP-тул сохранения профиля, затем отправь краткое резюме, перечисли ОКПД2 и выведи ID профиля. Дополнительных вопросов не задавай.

Общее
- Будь вежлив и лаконичен.
- Не придумывай значения, если данных нет; лучше уточни.
- <NEED_USER_INPUT> ставь только когда реально ждёшь ответа пользователя.
"""


def build_system_prompt() -> str:
    """
    Строит финальный системный промпт на основе Pydantic-модели CompanyProfileBase.
    Если ты поменяешь поля/описания в модели, промпт автоматически обновится.
    """
    fields_spec = _format_fields_for_prompt(CompanyProfileBase)
    example_json = _build_example_json(CompanyProfileBase)

    return _BASE_SYSTEM_PROMPT_TEMPLATE.format(
        fields_spec=fields_spec,
        example_json=example_json,
    )


BASE_SYSTEM_PROMPT = build_system_prompt()
