# Лабораторная работа 5: CrewAI Agent для AI Agents

Эта лабораторная работа демонстрирует создание мульти-агентной команды (crew) на базе **CrewAI** и её интеграцию с платформой **AI Agents** через протокол A2A.

## Обзор

CrewAI - это фреймворк для создания команд AI-агентов, которые работают вместе для решения сложных задач. В этой лабораторной работе вы:

1. Создадите команду агентов (crew) с разными ролями
2. Определите задачи для каждого агента
3. Интегрируете crew с MCP-серверами
4. Обернете crew для работы через A2A протокол
5. Развернете crew в платформе AI Agents

## Технологии

- **Python 3.12**
- **CrewAI** (>=0.80.0) - фреймворк для мульти-агентных команд
- **CrewAI Tools** - инструменты для агентов
- **A2A SDK** (>=0.3.4) - протокол Agent-to-Agent
- **LiteLLM** - унификация доступа к LLM
- **OpenInference** - телеметрия и трейсинг
- **Docker** - контейнеризация

## Структура проекта

```
lab5-crewai-agent/
├── src/
│   ├── __init__.py
│   ├── agents.py            # Определение агентов в crew
│   ├── tasks.py             # Определение задач
│   ├── crew.py              # Определение crew
│   ├── a2a_wrapper.py       # Обертка для A2A протокола
│   ├── agent_task_manager.py # Интеграция с A2A executor
│   └── start_a2a.py         # Точка входа приложения
├── Dockerfile               # Определение Docker-образа
├── pyproject.toml           # Зависимости проекта
└── README.md                # Этот файл
```

## Особенности реализации

### 1. Мульти-агентная команда

Crew состоит из нескольких агентов с разными ролями:

- **Координатор** - анализирует запрос и распределяет задачи
- **Исполнитель** - выполняет задачи используя инструменты

### 2. Задачи (Tasks)

Задачи определяют, что должен делать каждый агент:

```python
analyze_task = Task(
    description="Проанализируй запрос пользователя",
    agent=coordinator,
    expected_output="План выполнения"
)

execute_task = Task(
    description="Выполни запрос используя инструменты",
    agent=executor,
    expected_output="Результат выполнения"
)
```

### 3. Интеграция с MCP

Инструменты из MCP-серверов преобразуются в CrewAI Tools через кастомный `MCPTool`.

### 4. A2A Обертка

`CrewAIA2AWrapper` преобразует интерфейс CrewAI crew в A2A-совместимый формат:
- Поддержка streaming через `kickoff_stream`
- Управление сессиями и историей диалога
- Обработка ошибок

## Переменные окружения

Агент использует стандартные переменные окружения AI Agents:

| Переменная | Описание |
|------------|----------|
| `LLM_MODEL` | Название модели LLM |
| `LLM_API_BASE` | Базовый URL API для LLM |
| `LLM_API_KEY` | API ключ для доступа к LLM |
| `AGENT_NAME` | Название агента |
| `AGENT_DESCRIPTION` | Описание агента |
| `AGENT_VERSION` | Версия агента |
| `AGENT_SYSTEM_PROMPT` | Системный промпт агента |
| `MCP_URL` | URL MCP-серверов (через запятую) |
| `URL_AGENT` | URL агента |
| `PORT` | Порт для запуска сервера |
| `PHOENIX_ENDPOINT` | Endpoint для Phoenix телеметрии |
| `ENABLE_PHOENIX` | Включить телеметрию (true/false) |

## Развертывание

### Шаг 1: Сборка Docker образа

```bash
docker buildx build --platform linux/amd64 -t crewai-agent .
```

### Шаг 2: Тегирование образа

```bash
docker tag crewai-agent:latest cloudru-labs.cr.cloud.ru/crewai-agent-repo:v1.0.0
```

### Шаг 3: Загрузка в Artifact Registry

```bash
docker push cloudru-labs.cr.cloud.ru/crewai-agent-repo:v1.0.0
```

### Шаг 4: Создание агента в UI

1. Откройте консоль AI Agents в cloud.ru
2. Создайте нового агента
3. Укажите Docker-образ из Artifact Registry
4. Настройте переменные окружения
5. Выберите MCP-серверы (опционально)
6. Сохраните и запустите агента

## Использование

После развертывания crew будет доступен через:
- UI чата в консоли AI Agents
- A2A протокол для интеграции с другими агентами
- REST API через A2A endpoints

## Примеры использования

### Финансовые расчеты

Если подключен MCP-сервер из lab1:

```
Пользователь: Рассчитай график аннуитетного кредита на 1 000 000 рублей 
              под 12% годовых на 5 лет

Координатор: Анализирую запрос... Нужно использовать инструмент loan_schedule_annuity
Исполнитель: [Использует инструмент и возвращает результат]
```

### Сложные задачи

CrewAI позволяет распределять сложные задачи между агентами:

```
Пользователь: Проанализируй финансовую ситуацию и предложи план действий

Координатор: Разбиваю задачу на этапы...
Исполнитель: [Выполняет каждый этап используя инструменты]
Координатор: Собираю результаты и формирую итоговый ответ
```

## Отличия от других фреймворков

1. **Мульти-агентность**: Несколько агентов работают вместе
2. **Распределение задач**: Автоматическое распределение задач между агентами
3. **Delegation**: Агенты могут делегировать задачи друг другу
4. **Структурированность**: Четкое разделение ролей и задач

## Дополнительные ресурсы

- [CrewAI Documentation](https://docs.crewai.com/)
- [CrewAI GitHub](https://github.com/joaomdmoura/crewAI)
- [A2A Protocol](https://github.com/google/a2a)
- [AI Agents Documentation](https://cloud.ru/docs/ai-agents/ug/index)

## Troubleshooting

### Crew не выполняет задачи

Проверьте:
- Правильность определения агентов и задач
- Системные промпты для каждого агента
- Процесс выполнения (sequential/hierarchical)

### Агенты не используют инструменты

Проверьте:
- Правильность URL MCP-серверов в `MCP_URL`
- Доступность MCP-серверов из контейнера
- Инструменты добавлены в список tools агента-исполнителя

### Проблемы с телеметрией

Если Phoenix не работает:
- Проверьте `PHOENIX_ENDPOINT`
- Убедитесь, что `ENABLE_PHOENIX=true`
- Проверьте доступность endpoint из контейнера


