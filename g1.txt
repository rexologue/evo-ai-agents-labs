##############
# FILE: .env #
##############

# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
DB_HOST=localhost
DB_PORT=5432
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=postgres

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ MCP —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
DB_MCP_HOST=0.0.0.0
DB_MCP_PORT=28001

# –î—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MCP
LOG_LEVEL=INFO


######################
# FILE: .env.example #
######################

# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
DB_HOST=localhost
DB_PORT=5432
DB_NAME=agents
DB_USER=postgres
DB_PASSWORD=postgres

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ MCP —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
DB_MCP_HOST=0.0.0.0
DB_MCP_PORT=8000

# –î—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MCP
LOG_LEVEL=INFO


####################
# FILE: Dockerfile #
####################

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ Python 3.13 slim –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
FROM python:3.13-slim

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ uv –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && pip install --no-cache-dir uv

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ uv —Å–Ω–∞—á–∞–ª–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è Docker —Å–ª–æ–µ–≤
COPY db-mcp/pyproject.toml ./

# –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –ø–æ–¥—Ö–æ–¥, —á—Ç–æ –∏ –ª–æ–∫–∞–ª—å–Ω–æ
RUN uv sync --no-editable

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY db-mcp/src/ ./src/
COPY models.py ./src/models.py

# –°–æ–∑–¥–∞–µ–º –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN useradd --create-home --shell /bin/bash --uid 1000 mcp && \
    chown -R mcp:mcp /app

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USER mcp

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç –¥–ª—è MCP —Å–µ—Ä–≤–µ—Ä–∞ (—Å–º. server.py ‚Üí 8000)
EXPOSE 8000

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã Python
ENV PYTHONPATH=/app \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONHASHSEED=random \
    UV_SYSTEM_PYTHON=1

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ - —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ
CMD ["uv", "run", "python", "src/server.py"]


########################
# FILE: pyproject.toml #
########################

[project]
name = "db-mcp"
version = "0.1.0"
description = "MCP server for company profiles and tender matches backed by PostgreSQL"
authors = [
    { name = "rexologue", email = "mironovigoroffical@gmail.com" }
]
requires-python = ">=3.11"
dependencies = [
    "fastmcp>=0.5.0",
    "uvicorn",
    "opentelemetry-api>=1.25.0",
    "pydantic>=2.6",
    "python-dotenv>=1.0",
    "psycopg[binary]>=3.1",
]

[build-system]
requires = ["setuptools>=61.0"]
build-backend = "setuptools.build_meta"


#########################
# FILE: src/__init__.py #
#########################



#######################
# FILE: src/config.py #
#######################

import os
import logging
from typing import Optional

from pydantic import Field, ValidationError
from pydantic_settings import BaseSettings

from dotenv import load_dotenv, find_dotenv
load_dotenv(find_dotenv())

LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
logging.basicConfig(
    level=getattr(logging, LOG_LEVEL, logging.INFO),
    format="%(asctime)s %(levelname)s %(name)s %(message)s",
)
logger = logging.getLogger("db-mcp")


class Settings(BaseSettings):
    db_host: str = Field(..., alias="DB_HOST")
    db_port: int = Field(..., alias="DB_PORT")
    db_name: str = Field(..., alias="DB_NAME")
    db_user: str = Field(..., alias="DB_USER")
    db_password: str = Field(..., alias="DB_PASSWORD")
    server_port: int = Field(..., alias="DB_MCP_PORT")
    server_host: str = Field(..., alias="DB_MCP_HOST")


# ------------------------------------------------------------------------------
# –§–∞–±—Ä–∏–∫–∞
# ------------------------------------------------------------------------------
_settings_cache: Optional[Settings] = None


def get_settings() -> Settings:
    """Singleton-–∫–µ—à, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 100 —Ä–∞–∑"""
    global _settings_cache
    
    if _settings_cache is None:
        try:
            _settings_cache = Settings()
            
        except ValidationError as e:
            logger.error("‚ùå Invalid configuration:")
            logger.error(e)
            raise
        
    return _settings_cache


###################
# FILE: src/db.py #
###################

"""–£—Ç–∏–ª–∏—Ç—ã —Ä–∞–±–æ—Ç—ã —Å PostgreSQL –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π –∫–æ–º–ø–∞–Ω–∏–π."""

from __future__ import annotations

import json
from contextlib import contextmanager
from datetime import datetime
from typing import Any, Iterable
from uuid import uuid4

import psycopg

from config import get_settings
from models import CompanyProfileBase, CompanyProfileDB

settings = get_settings()


@contextmanager
def get_conn():
    """–°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —Å –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç–æ–º."""

    conn = psycopg.connect(
        host=settings.db_host,
        port=settings.db_port,
        dbname=settings.db_name,
        user=settings.db_user,
        password=settings.db_password,
        autocommit=True,
    )
    try:
        yield conn
    finally:
        conn.close()


def ensure_tables() -> None:
    """–°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç."""

    create_sql = """
    CREATE TABLE IF NOT EXISTS companies (
        id UUID PRIMARY KEY,
        name TEXT NOT NULL,
        description TEXT NOT NULL,
        profile_json JSONB NOT NULL,
        created_at TIMESTAMPTZ NOT NULL,
        updated_at TIMESTAMPTZ NOT NULL
    );
    """
    with get_conn() as conn:
        with conn.cursor() as cur:
            cur.execute(create_sql)


def map_row_to_profile(row: Iterable[Any]) -> CompanyProfileDB:
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å—Ç—Ä–æ–∫—É –ë–î –≤ –º–æ–¥–µ–ª—å CompanyProfileDB."""

    (
        company_id,
        name,
        description,
        profile_json,
        created_at,
        updated_at,
    ) = row
    base_profile = CompanyProfileBase(**profile_json)
    profile_data = base_profile.model_dump()
    profile_data["name"] = name
    profile_data["description"] = description
    return CompanyProfileDB(
        id=company_id,
        created_at=created_at,
        updated_at=updated_at,
        **profile_data,
    )


def insert_company_profile(profile: CompanyProfileBase) -> CompanyProfileDB:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ –≤ PostgreSQL."""

    now = datetime.utcnow()
    company_id = uuid4()
    profile_dict = json.loads(profile.model_dump_json())

    sql = """
    INSERT INTO companies (id, name, description, profile_json, created_at, updated_at)
    VALUES (%s, %s, %s, %s, %s, %s)
    RETURNING id, name, description, profile_json, created_at, updated_at;
    """

    with get_conn() as conn:
        with conn.cursor() as cur:
            cur.execute(
                sql,
                (
                    company_id,
                    profile.name,
                    profile.description,
                    json.dumps(profile_dict),
                    now,
                    now,
                ),
            )
            row = cur.fetchone()
            return map_row_to_profile(row)


def fetch_company_profile(company_id: str) -> CompanyProfileDB:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É."""

    sql = """
    SELECT id, name, description, profile_json, created_at, updated_at
    FROM companies
    WHERE id = %s;
    """
    with get_conn() as conn:
        with conn.cursor() as cur:
            cur.execute(sql, (company_id,))
            row = cur.fetchone()
            if not row:
                raise ValueError("Company not found")
            return map_row_to_profile(row)


def fetch_company_profiles(query: str | None, limit: int, offset: int) -> list[CompanyProfileDB]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –∫–æ–º–ø–∞–Ω–∏–π —Å –ø–æ–∏—Å–∫–æ–º –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""

    base_sql = """
    SELECT id, name, description, profile_json, created_at, updated_at
    FROM companies
    """

    with get_conn() as conn:
        with conn.cursor() as cur:
            if query:
                like = f"%{query}%"
                sql = base_sql + """
                WHERE name ILIKE %s OR description ILIKE %s
                ORDER BY created_at DESC
                LIMIT %s OFFSET %s;
                """
                params = (like, like, limit, offset)
            else:
                sql = base_sql + """
                ORDER BY created_at DESC
                LIMIT %s OFFSET %s;
                """
                params = (limit, offset)

            cur.execute(sql, params)
            rows = cur.fetchall()
            return [map_row_to_profile(row) for row in rows]



#############################
# FILE: src/mcp_instance.py #
#############################

"""–ï–¥–∏–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä FastMCP –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""

from fastmcp import FastMCP

mcp = FastMCP(
    "PostgreSQL-backed MCP for company profiles",
)


#######################
# FILE: src/server.py #
#######################

"""MCP —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –∫–æ–º–ø–∞–Ω–∏–π –≤ PostgreSQL."""

from __future__ import annotations

from config import get_settings
from db import ensure_tables

# CORS + ASGI
from starlette.middleware import Middleware
from starlette.middleware.cors import CORSMiddleware
import uvicorn

# –ï–¥–∏–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä FastMCP
from mcp_instance import mcp

settings = get_settings()
ensure_tables()

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ)
print("üîß –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã...")
try:
    from tools.create_company_profile import create_company_profile
    print("‚úÖ create_company_profile –∑–∞–≥—Ä—É–∂–µ–Ω")
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ create_company_profile: {e}")
    import traceback
    traceback.print_exc()

try:
    from tools.get_company_profile import get_company_profile
    print("‚úÖ get_company_profile –∑–∞–≥—Ä—É–∂–µ–Ω")
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ get_company_profile: {e}")
    import traceback
    traceback.print_exc()

try:
    from tools.list_company_profiles import list_company_profiles
    print("‚úÖ list_company_profiles –∑–∞–≥—Ä—É–∂–µ–Ω")
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ list_company_profiles: {e}")
    import traceback
    traceback.print_exc()

# --- CORS middleware —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è MCP Inspector ---

middleware = [
    Middleware(
        CORSMiddleware,
        allow_origins=["*"],  # –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏; –≤ –ø—Ä–æ–¥–µ –ª—É—á—à–µ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π origin
        allow_methods=["GET", "POST", "DELETE", "OPTIONS"],
        allow_headers=[
            "mcp-protocol-version",
            "mcp-session-id",
            "Authorization",
            "Content-Type",
        ],
        expose_headers=["mcp-session-id"],
    )
]

# ASGI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastMCP c CORS
app = mcp.http_app(middleware=middleware)  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Ç—å /mcp


def main():
    """–ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞ —Å HTTP —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º –∏ CORS."""
    print("=" * 60)
    print("üåê –ó–ê–ü–£–°–ö MCP –°–ï–†–í–ï–†–ê (HTTP + CORS)")
    print("=" * 60)
    print(f"üöÄ MCP Server: http://{settings.server_host}:{settings.server_port}/mcp")
    print(f"üìä –ú–µ—Ç—Ä–∏–∫–∏:    http://{settings.server_host}:{settings.server_port}/metrics")
    print(f"üè• Health:     http://{settings.server_host}:{settings.server_port}/health")
    print("üîß –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ MCP Inspector (Connection Type: Direct)")
    print("=" * 60)
    print("‚è≥ –ó–∞–ø—É—Å–∫–∞–µ–º Uvicorn...")

    try:
        uvicorn.run(
            app,
            host=settings.server_host,
            port=settings.server_port,
        )
    except KeyboardInterrupt:
        print("\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (Ctrl+C)")
        print("üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º graceful shutdown...")
        print("‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()


###############################
# FILE: src/tools/__init__.py #
###############################

"""–ù–∞–±–æ—Ä MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–ø–∞–Ω–∏—è–º–∏."""


#############################################
# FILE: src/tools/create_company_profile.py #
#############################################

"""–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –ë–î."""

from __future__ import annotations

from fastmcp import Context
from mcp.types import TextContent
from pydantic import Field

from db import ensure_tables, insert_company_profile
from mcp_instance import mcp
from models import CompanyProfileBase
from tools.utils import ToolResult, _require_env_vars


@mcp.tool(
    name="create_company_profile",
    description="üìù –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ PostgreSQL.",
)
async def create_company_profile(
    ctx: Context,
    profile: CompanyProfileBase = Field(
        ..., description="–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
    ),
) -> ToolResult:
    _require_env_vars(["DB_HOST", "DB_PORT", "DB_NAME", "DB_USER", "DB_PASSWORD"])
    
    if profile is None:
        await ctx.info("‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö")
        return ToolResult(
            content=[
                TextContent(
                    type="text",
                    text="–û—à–∏–±–∫–∞: –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç 'profile' –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ create_company_profile.",
                )
            ],
            structured_content=None,
            meta={"operation": "create_company_profile", "error": "missing_profile"},
        )

    await ctx.info("üöÄ –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏")
    await ctx.report_progress(progress=0, total=100)

    ensure_tables()
    await ctx.info("üîß –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ —Å—Ö–µ–º—É –ë–î")
    await ctx.report_progress(progress=25, total=100)

    saved_profile = insert_company_profile(profile)
    await ctx.report_progress(progress=75, total=100)
    await ctx.info("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω")

    await ctx.report_progress(progress=100, total=100)

    return ToolResult(
        content=[
            TextContent(
                type="text",
                text=f"–ü—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ {saved_profile.name} —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Å id {saved_profile.id}",
            )
        ],
        structured_content=saved_profile.model_dump(),
        meta={"operation": "create_company_profile"},
    )



##########################################
# FILE: src/tools/get_company_profile.py #
##########################################

"""–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ UUID."""

from __future__ import annotations

from fastmcp import Context
from mcp.shared.exceptions import ErrorData, McpError
from mcp.types import TextContent
from pydantic import Field

from db import ensure_tables, fetch_company_profile
from mcp_instance import mcp
from tools.utils import ToolResult, _require_env_vars


@mcp.tool(
    name="get_company_profile",
    description="""üîç –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ UUID.""",
)
async def get_company_profile(
    company_id: str = Field(..., description="UUID –∫–æ–º–ø–∞–Ω–∏–∏"),
    ctx: Context = None,
) -> ToolResult:
    """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É.

    Args:
        company_id: UUID –∫–æ–º–ø–∞–Ω–∏–∏.
        ctx: –ö–æ–Ω—Ç–µ–∫—Å—Ç MCP –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

    Returns:
        ToolResult: –ù–∞–π–¥–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏.

    Raises:
        McpError: –ï—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.
    """

    _require_env_vars(["DB_HOST", "DB_PORT", "DB_NAME", "DB_USER", "DB_PASSWORD"])

    await ctx.info("üîé –ò—â–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏")
    await ctx.report_progress(progress=0, total=100)

    ensure_tables()
    await ctx.report_progress(progress=25, total=100)

    try:
        profile = fetch_company_profile(company_id)
    except ValueError as exc:
        await ctx.error(f"‚ùå –ö–æ–º–ø–∞–Ω–∏—è —Å id {company_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

        raise McpError(
            ErrorData(code=-32601, message=f"–ö–æ–º–ø–∞–Ω–∏—è {company_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        )

    await ctx.report_progress(progress=100, total=100)
    await ctx.info("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –Ω–∞–π–¥–µ–Ω")

    return ToolResult(
        content=[
            TextContent(
                type="text",
                text=f"–ö–æ–º–ø–∞–Ω–∏—è {profile.name}: {profile.description}",
            )
        ],
        structured_content=profile.model_dump(),
        meta={"operation": "get_company_profile"},
    )


############################################
# FILE: src/tools/list_company_profiles.py #
############################################

"""–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –∫–æ–º–ø–∞–Ω–∏–π."""

from __future__ import annotations

from fastmcp import Context
from mcp.types import TextContent
from pydantic import Field

from db import ensure_tables, fetch_company_profiles
from mcp_instance import mcp
from tools.utils import ToolResult, _require_env_vars


@mcp.tool(
    name="list_company_profiles",
    description="""üìÑ –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –∫–æ–º–ø–∞–Ω–∏–π —Å –ø–æ–∏—Å–∫–æ–º –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.""",
)
async def list_company_profiles(
    query: str | None = Field(
        default=None, description="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é"
    ),
    limit: int = Field(default=20, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –≤—ã–¥–∞—á–µ"),
    offset: int = Field(default=0, description="–°–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏"),
    ctx: Context = None,
) -> ToolResult:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –∫–æ–º–ø–∞–Ω–∏–π.

    Args:
        query: –°—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é.
        limit: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
        offset: –°–º–µ—â–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏.
        ctx: –ö–æ–Ω—Ç–µ–∫—Å—Ç MCP.

    Returns:
        ToolResult: –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –∫–æ–º–ø–∞–Ω–∏–π.
    """

    _require_env_vars(["DB_HOST", "DB_PORT", "DB_NAME", "DB_USER", "DB_PASSWORD"])

    await ctx.info("üìë –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –∫–æ–º–ø–∞–Ω–∏–π")
    await ctx.report_progress(progress=0, total=100)

    ensure_tables()
    await ctx.report_progress(progress=25, total=100)

    profiles = fetch_company_profiles(query, limit, offset)
    await ctx.report_progress(progress=100, total=100)
    await ctx.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: {len(profiles)}")

    formatted = "\n".join([f"- {profile.name}" for profile in profiles]) or "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"

    return ToolResult(
        content=[TextContent(type="text", text=formatted)],
        structured_content={"items": [p.model_dump() for p in profiles]},
        meta={"operation": "list_company_profiles"},
    )


############################
# FILE: src/tools/utils.py #
############################

"""–û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ db-mcp."""

from __future__ import annotations

import os
from dataclasses import dataclass, field
from typing import Any

from mcp.shared.exceptions import ErrorData, McpError
from mcp.types import Content


@dataclass
class ToolResult:
    """–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞."""

    content: list[Content]
    structured_content: dict[str, Any] = field(default_factory=dict)
    meta: dict[str, Any] = field(default_factory=dict)


def _require_env_vars(names: list[str]) -> dict[str, str]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è."""

    missing = [name for name in names if not os.getenv(name)]
    if missing:
        raise McpError(
            ErrorData(
                code=-32602,
                message="–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: "
                + ", ".join(missing),
            )
        )
    return {name: os.getenv(name, "") for name in names}


