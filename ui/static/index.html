<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Company Profiler UI</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 24px;
      text-align: center;
    }

    .layout {
      display: flex;
      gap: 16px;
      align-items: stretch;
      height: calc(100vh - 80px);
    }

    .chat,
    .profiles {
      background: #020617;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 0 0 1px #1e293b;
      display: flex;
      flex-direction: column;
    }

    .chat {
      flex: 2;
      min-width: 0;
    }

    .profiles {
      flex: 1;
      min-width: 0;
    }

    .chat-log {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    .msg {
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .msg.user {
      background: #1d4ed8;
      align-self: flex-end;
    }

    .msg.assistant {
      background: #111827;
      border: 1px solid #1f2937;
      align-self: flex-start;
    }

    .msg pre {
      margin: 0;
      font-family: Consolas, Menlo, Monaco, "Courier New", monospace;
      font-size: 13px;
    }

    .chat-input {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    #user-input {
      flex: 1;
      resize: none;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      font-family: inherit;
    }

    #user-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    #send-btn {
      padding: 0 16px;
      border-radius: 8px;
      border: none;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    #send-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .profiles h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #020617;
    }

    th,
    td {
      padding: 6px 4px;
      border-bottom: 1px solid #1f2937;
      vertical-align: middle;
    }

    th {
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #9ca3af;
    }

    .profiles-table-wrapper {
      flex: 1;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
    }

    .id-input {
      width: 100%;
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-family: monospace;
      font-size: 12px;
    }

    .copy-btn {
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      background: #3b82f6;
      color: #eff6ff;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .copy-btn:active {
      transform: scale(0.97);
    }

    .profiles-footer {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
        height: auto;
      }
      .chat,
      .profiles {
        height: 50vh;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Company Profiler — веб UI к агенту</h1>
    <div class="layout">
      <div class="chat">
        <div id="chat-log" class="chat-log"></div>
        <div class="chat-input">
          <textarea id="user-input" rows="3" placeholder="Напишите сообщение агенту, затем Enter (или Shift+Enter для переноса строки)"></textarea>
          <button id="send-btn">Отправить</button>
        </div>
      </div>
      <div class="profiles">
        <h2>Сохранённые профили</h2>
        <div class="profiles-table-wrapper">
          <table id="profiles-table">
            <thead>
              <tr>
                <th>Имя компании</th>
                <th>ID компании</th>
                <th>Создано</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="profiles-footer">
          Профили добавляются автоматически, когда агент возвращает JSON с <code>company_id</code> и <code>profile.name</code>. Данные хранятся в файле <code>data/profiles.json</code>.
        </div>
      </div>
    </div>
  </div>

  <script>
    const chatLog = document.getElementById("chat-log");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    function getSessionId() {
      const key = "company-profiler-session-id";
      let id = localStorage.getItem(key);
      if (!id) {
        if (window.crypto && window.crypto.randomUUID) {
          id = window.crypto.randomUUID();
        } else {
          id = Math.random().toString(36).slice(2);
        }
        localStorage.setItem(key, id);
      }
      return id;
    }

    function appendMessage(role, text) {
      const div = document.createElement("div");
      div.className = "msg " + role;
      const pre = document.createElement("pre");
      pre.textContent = text;
      div.appendChild(pre);
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) {
        return;
      }
      appendMessage("user", text);
      userInput.value = "";
      sendBtn.disabled = true;

      try {
        const res = await fetch("/api/message", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            message: text,
            session_id: getSessionId(),
          }),
        });

        const data = await res.json();
        if (!res.ok) {
          appendMessage("assistant", "Ошибка: " + (data.detail || data.error || res.status));
        } else {
          const assistantText =
            data.assistant_text ||
            "[нет текстового ответа: смотри полное тело ответа в консоли браузера]";
          appendMessage("assistant", assistantText);

          if (data.saved_profile) {
            await loadProfiles();
          }

          // Для отладки: полный ответ агента
          console.log("RAW agent response:", data.raw);
        }
      } catch (err) {
        console.error(err);
        appendMessage("assistant", "Ошибка при запросе к backend: " + err);
      } finally {
        sendBtn.disabled = false;
        userInput.focus();
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    userInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    async function loadProfiles() {
      try {
        const res = await fetch("/api/profiles");
        const data = await res.json();
        const tbody = document.querySelector("#profiles-table tbody");
        tbody.innerHTML = "";

        const profiles = data.profiles || [];
        for (const p of profiles) {
          const tr = document.createElement("tr");

          const nameTd = document.createElement("td");
          nameTd.textContent = p.company_name || "(без названия)";

          const idTd = document.createElement("td");
          const idInput = document.createElement("input");
          idInput.className = "id-input";
          idInput.type = "text";
          idInput.readOnly = true;
          idInput.value = p.company_id || "";
          idTd.appendChild(idInput);

          const createdTd = document.createElement("td");
          if (p.created_at) {
            const dt = new Date(p.created_at);
            createdTd.textContent = dt.toLocaleString();
          } else {
            createdTd.textContent = "";
          }

          const actionTd = document.createElement("td");
          const copyBtn = document.createElement("button");
          copyBtn.className = "copy-btn";
          copyBtn.textContent = "Копировать ID";
          copyBtn.addEventListener("click", () => {
            if (!p.company_id) return;
            navigator.clipboard
              .writeText(p.company_id)
              .catch(() => {});
          });
          actionTd.appendChild(copyBtn);

          tr.appendChild(nameTd);
          tr.appendChild(idTd);
          tr.appendChild(createdTd);
          tr.appendChild(actionTd);
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error("Ошибка загрузки профилей:", err);
      }
    }

    // Инициализация
    loadProfiles();
    userInput.focus();
  </script>
</body>
</html>
